# STM32 平衡车项目

本项目是一个基于STM32微控制器的自平衡小车实现。该小车能够通过MPU6050陀螺仪和加速度计检测车身姿态，采用PID控制算法实现自平衡功能。

## 项目概述

这是一个双轮自平衡小车项目，使用STM32F1系列微控制器作为主控芯片。小车通过MPU6050六轴传感器获取车身姿态信息，结合编码器和超声波传感器的数据，使用PID控制算法实现小车的自平衡和运动控制。

## 硬件组成

- **主控芯片**: STM32F1系列微控制器
- **姿态检测**: MPU6050六轴传感器（陀螺仪+加速度计）
- **电机驱动**: 两个直流电机用于驱动小车
- **速度检测**: 编码器用于检测车轮转速
- **距离检测**: HC-SR04超声波传感器用于测量前方障碍物距离
- **用户界面**: OLED显示屏用于显示状态信息
- **通信接口**: USART串口用于调试和数据传输

## 软件架构

### 主要模块

1. **姿态检测模块** (MPU6050)
   - 使用DMP（数字运动处理器）解算姿态角
   - 提供Roll角度数据用于直立控制

2. **电机控制模块** (MOTOR)
   - PWM控制直流电机转速和方向
   - 差速控制实现小车转向

3. **速度检测模块** (ENCODER)
   - 利用定时器编码器模式读取编码器数据
   - 实时获取车轮转速信息

4. **PID控制模块**
   - 双环PID控制：
     - 内环：直立环（快速响应姿态变化）
     - 外环：速度环（控制整体平衡点）
   - 参数可调，适应不同场景需求

5. **距离检测模块** (HC-SR04)
   - 超声波测距，检测前方障碍物
   - 防碰撞功能

6. **显示模块** (OLED)
   - 实时显示姿态角度、距离等信息
   - 系统状态可视化

### 控制算法

采用串级PID控制策略：

1. **内环直立控制**（10ms周期）
   - 快速响应车身姿态变化
   - 维持小车直立状态

2. **外环速度控制**（与直立环同步执行）
   - 控制小车整体平衡点
   - 实现前进、后退控制

## 系统工作流程

1. 系统初始化各外设模块
2. MPU6050初始化并开始姿态解算
3. 主循环中：
   - 读取MPU6050姿态数据
   - 读取编码器速度数据
   - 执行PID控制算法计算电机输出
   - 更新OLED显示信息
   - 处理超声波传感器数据

## 主要特性

- 实时姿态检测与反馈控制
- 双环PID控制保证系统稳定性
- OLED状态显示
- 超声波避障功能
- 机械倒下自动保护（停止电机输出）
- 可调节的PID参数

## 使用说明

1. 硬件组装完成后，连接电源
2. 系统自动初始化并开始平衡控制
3. 通过调整PID参数优化控制效果
4. OLED屏幕显示实时姿态和距离信息

## 注意事项

- 当检测到车身倾角超过45度时，系统会自动停止电机输出以保护硬件
- PID参数需要根据实际机械结构和重心位置进行调整
- 确保传感器安装牢固，避免震动影响检测精度

## 开发环境

- IDE: Keil MDK-ARM
- 编程语言: C语言
- 调试工具: ST-Link

## 文件结构

```
balance-car/
├── Core/           # 核心代码（STM32 HAL库相关）
├── Drivers/        # 驱动程序（CMSIS和HAL库）
├── MDK-ARM/        # Keil项目文件
├── User/           # 用户代码
│   ├── Application/ # 应用层代码（PID控制）
│   ├── Hardware/   # 硬件驱动（电机、传感器等）
│   └── System/     # 系统底层（延时、I2C等）
└── README.md
```